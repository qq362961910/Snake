<!--html4使用-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--html5使用-->
<!--<!DOCTYPE html>-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tian An Men 3D</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script type="text/javascript" src="/web/static/js/three.js"></script>
    <script type="text/javascript" src="/web/static/js/MTLLoader.js"></script>
    <script type="text/javascript" src="/web/static/js/OBJLoader.js"></script>
    <script type="text/javascript" src="/web/static/js/OrbitControls.js"></script>
    <!--Normalize.css是一种CSS reset的替代方案,在默认的HTML元素样式上提供了跨浏览器的高度一致性。相比于传统的CSS reset，Normalize.css是一种现代的、为HTML5准备的优质替代方案-->
    <link type="text/css" rel="stylesheet" href="/web/static/css/normalize.css"/>
    <style type="text/css">
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="container"></div>
</body>
<script type="text/javascript">
    /**
     * 问题:
     * 1.设置window.innerWidth，window.innerHeight会多出一点滚动条
     * 2.加载玩mtl文件后执行的materials.preload();有什么作用
     *
     * */
</script>
<script type="text/javascript">
    /**
     * 总结
     * 1.THREE.Object3D:
     *      Object3D似乎是Three.js框架中最重要的类，相当一部分其他的类都是继承自Object3D类，
     *      比如场景类、几何形体类、相机类、光照类等等：他们都是3D空间中的对象，所以称为Object3D类
     *
     * 2.THREE.SpriteMaterial(精灵材质)
     *      SpriteMaterial粒子的基本材质
     *      Sprite叫精灵，计算机图形学中，精灵指包含于场景中的二维图像或动画(wiki)
     *      例子:http://threejs-outsidelook.oss-cn-shanghai.aliyuncs.com/r89/source/examples/index.html?q=spr#webgl_sprites
     *
     * 3.
     * */
</script>
<script type="text/javascript">
    function $(id) {
        if (typeof id == UNDEFINED || typeof id != STRING || id == null) {
            return null;
        }
        if (id.startwith('#')) {
            return document.getElementById(id.substring(1));
        }
        else if (id.startwith(".")) {
            return document.getElementsByClassName(id.substring(1));
        }
        else {
            var eles = document.getElementsByTagName(id);
            if (eles.length > 0) {
                return eles[0];
            }
            return null;
        }
    }
    if(!window.addEventListener) {
        window.addEventListener = window.attachEvent;
    }
</script>
<script type="text/javascript">
//定义常量
var rootPath = location.origin;
var OBJECTS_TO_LOAD = [
    {
        mtl: "tiananmen.mtl",
        obj: "tiananmen.obj"
    }
];
</script>
<script type="text/javascript">
    var renderer;
    var scene;
    var camera;
    var axisHelper;
    var directWhiteLight;
    var directBlueLight;
    var directBlackLight;
    var resourcePathFor3d="/web/static/3d/";
    var orbitController;
    //用来拾取场景里面的物体,更方便用鼠标操作3Ｄ场景
    var raycaster = new THREE.Raycaster();

    var init = function() {
        //1.初始化组建
        //渲染器, antialias是否优化边缘
        renderer = new THREE.WebGLRenderer({antialias: true});
        //画布大小
        renderer.setSize(window.innerWidth, window.innerHeight);
        //紫色背景,不透明
        renderer.setClearColor(0xaaaaff, 1.0);
        //设备像素比，一般为１
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById("container").appendChild(renderer.domElement);
        //场景
        scene = new THREE.Scene();
        //相机
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 100000);
        //环形轨道控制器
        orbitController = new THREE.OrbitControls(camera, renderer.domElement);
        orbitController.addEventListener('change', render);
        //白色平行光照
        directWhiteLight = new THREE.DirectionalLight(0xffffff);
        directWhiteLight.position.set(1, 1, 1);
        scene.add(directWhiteLight);
        //蓝色平行光照
        directBlueLight = new THREE.DirectionalLight(0x002288);
        directBlueLight.position.set(-1, -1, -1);
        scene.add(directBlueLight);
        //黑色环境光照
        directBlackLight = new THREE.AmbientLight(0x222222);
        scene.add(directBlackLight);

        //坐标系
        axisHelper = new THREE.AxisHelper(7);
        scene.add(axisHelper);

        console.info("init component ok....");
        //2.添加物体
        //材质加载器,模型加载器
        var mtlLoader = new THREE.MTLLoader();
        var objLoader = new THREE.OBJLoader();
        mtlLoader.setPath(resourcePathFor3d);
        objLoader.setPath(resourcePathFor3d);
        for (var i=0; i<OBJECTS_TO_LOAD.length; i++) {
            var objJson = OBJECTS_TO_LOAD[i];
            mtlLoader.load(objJson.mtl, function(materials) {
                materials.preload();
                objLoader.setMaterials(materials);
                objLoader.load(objJson.obj, function (object) {
                    scene.add(object);
                    var box= new THREE.Box3().setFromObject(object);
                    camera.position.set(box.getCenter().x, box.getCenter().y+3000, box.getCenter().z+10000);
                    orbitController.update();
                    render();
                }, function () {
                    console.info("on progress....");
                }, function () {
                    console.info("on error");
                });
            });
        };
        //渲染
        render();
    }();

    function render() {
        renderer.render(scene, camera);
    }

</script>
<script type="text/javascript">
    //时间精度比较大,cpu使用率过高时会自动跳过某些帧, 一般在60FPS左右
    function animate() {
        requestAnimationFrame( animate );
        orbitController.update();
        render();
    }
    window.onresize = function() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        render();
    }
</script>
</html>